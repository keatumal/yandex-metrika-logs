#+title: Набор утилит для работы с данными Яндекс Метрики через Logs API

* Описание

Набор утилит для работы с не агрегированными данными Яндекс Метрики через Logs API. С официальной документацией API можно ознакомиться [[https://yandex.com/dev/metrika/ru/logs/][здесь]].

* Установка

1. Клонируйте репозиторий:

   #+begin_src sh
     git clone https://github.com/keatumal/yandex-metrika-logs.git
     cd yandex-metrika-logs
   #+end_src

2. Установите зависимости:

   С помощью [[https://github.com/astral-sh/uv][uv]]:
  
   #+begin_src sh
     uv sync
   #+end_src

   Или через =pip=:
   
   #+begin_src sh
  pip install -r requirements.txt
  #+end_src

*  Использование

1. Создайте ~.env~ (описание ниже, пример в ~.env.example~)
2. Создайте ~src/config.py~ (описание ниже, пример в ~src/config_example.py~)
3. Запустите нужный скрипт:
   
   Через =uv=:
   
      #+begin_src sh
        uv run src/scripts/<script_name.py>
      #+end_src

   Или, если устанавливали через =pip=:
   
     #+begin_src
     python src/scripts/<script_name.py>
     #+end_src

* Скрипты

Находятся в директории ~src/scripts~ и могут быть запущены из любого места. Для каждого скрипта есть справка по аргументам и использованию через =-h, --help=.

У скриптов есть возможность переименования стандартных названий полей в более удобные. Как правило за это отвечает аргумент =-R=. По умолчанию скрипты работают с оригинальными названиями полей.

** =download_logs.py=

Позволяет запрашивать и/или скачивать отчёты. Отчёты невозможно запросить за текущий день и на период больше года.

** =reports.py=

Позволяет выводить список готовых отчётов и удалять их. Скрипт *не запрашивает* подтверждение на удаление.

** =clickhouse.py=

Позволяет загружать данные из TSV файла в Clickhouse, а также создать новую пустую таблицу по конфигурации.

* Конфигурация

Задаётся в файлах ~.env~ и ~src/config.py~.

** ~.env~

- =YM_AUTH_TOKEN=: OAuth-токен. Как получить, [[https://yandex.com/dev/metrika/ru/intro/authorization][рассказал Яндекс]].
- =CLICKHOUSE_{HOST,PORT,USER,PASSWORD}=: конфигурация для Clickhouse

** ~src/config.py~

Все перечисленные ниже параметры обязательны, значения по-умолчанию на данный момент не предусмотрены.

- =WAIT_INTERVAL=: это интервал в секундах между проверками готовности отчёта.
- =DEFAULT_ATTRIBUTION_MODEL=: модель атрибуции по-умолчанию. Список возможных значений можно посмотреть, например, [[https://yandex.ru/dev/metrika/ru/logs/openapi/getLogRequests][здесь]].
- =DOWNLOAD_SOURCE=: источник данных для запроса отчёта: визиты (=visits=) или события (=hits=).
- =CLICKHOUSE_BATCH_SIZE=: сколько строк загружать в Clickhouse за раз.
- =DOWNLOAD_FIELDS=: Поля, которые запрашиваем в отчёте для скачивания. Ключом (до двоеточия) является имя поля для API, а значением (после двоеточия) его итоговое имя в файле.

  По-умолчанию сейчас там содержится большой список полей для визитов пользователей. Дополнительные можно найти в [[https://yandex.com/dev/metrika/ru/logs/fields/hits][документации]].

  =<attr>= заменяется на модель атрибуции по-умолчанию, или которую передали скрипту.

  Для остальных подобных переменных в файле действуют такие же правила.
- =CLICKHOUSE_VISITS_FIELDS=, =CLICKHOUSE_EVENTS_FIELDS=: названия колонок Clickhouse, которые содержатся или будут созданы в таблицах визитов/событий.
- =CLICKHOUSE_CREATE_VISITS_TABLE=, =CLICKHOUSE_CREATE_EVENTS_TABLE=: команда для создания новой таблицы визитов/событий. Поддерживаются следующие подстановки:

  - =$table_name=: название таблицы, переданное скрипту.
  - =$table_fields=: название колонок таблицы, которые получились из переменных =CLICKHOUSE_*_FIELDS=
- =ATTRIBUTION_RENAMING_MAPPING=: словарь для переименования стандартных названий моделей атрибуции в более удобные. Оригинальное название -> новое название.
- =FIELDS_RENAMING_MAPPING=: тоже самое, только для названий полей. =<attr>= заменяется на все возможные значения из =ATTRIBUTION_RENAMING_MAPPING=.
  
* Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле LICENSE.

* Контакты

Если у вас есть вопросы или предложения, свяжитесь со мной через Telegram: https://t.me/anakvad
